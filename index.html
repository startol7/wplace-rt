<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TePlace ‚Äî Real World Map Conquest</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- App CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ================== Top floating header ================== -->
  <header class="floating-bar">
    <div class="brand">üåç TePlace</div>

    <div class="spacer"></div>

    <div class="country-pill">
      <span class="label">Your country:</span>
      <select id="countrySelect" aria-label="Your country"></select>
    </div>

    <button id="signBtn" class="pill-btn" type="button">Sign in</button>
  </header>

  <!-- ================== Panels (Ranking / Stats / Color) ================== -->
  <section class="info-panels panels-mobile-order">
    <details open>
      <summary>üèÜ World Ranking
        <span class="periods">
          <button class="seg-btn active" data-period="today" type="button">Today</button>
          <button class="seg-btn" data-period="week" type="button">Week</button>
          <button class="seg-btn" data-period="month" type="button">Month</button>
        </span>
      </summary>
      <ul id="rankingList" class="ranking-list">
        <li>No data yet</li>
      </ul>
    </details>

    <details open>
      <summary>üìä Statistics</summary>
      <div class="stats">
        <div class="stat-row"><span>Total territories</span><strong id="statTotal">0</strong></div>
        <div class="stat-row"><span>My territories</span><strong id="statMine">0</strong></div>
        <div class="stat-row"><span>Online (approx)</span><strong id="statOnline">0</strong></div>
      </div>
    </details>

    <details open>
      <summary>üé® Color</summary>
      <div class="color-box">
        <label class="color-row">
          <span>Color</span>
          <input id="colorHex" type="text" value="#ff4b4b" />
          <div class="color-chip"><input id="colorPicker" type="color" value="#ff4b4b" /></div>
        </label>

        <div class="tile-size">
          <div class="tile-title">Tile size</div>
          <div class="seg">
            <button class="seg-btn" data-tile="0.005" type="button">0.005¬∞</button>
            <button class="seg-btn" data-tile="0.001" type="button">0.001¬∞</button>
            <button class="seg-btn active" data-tile="0.0005" type="button">0.0005¬∞</button>
          </div>
          <div class="tile-custom">
            <input id="tileCustom" inputmode="decimal" placeholder="0.0005" />
            <button id="tileApply" class="pill-btn" type="button">Apply</button>
          </div>
        </div>

        <div class="note">1√ó1 only „Éª Cooldown: 10s</div>
      </div>
    </details>
  </section>

  <!-- ================== Map (always bottom on mobile) ================== -->
  <main id="mapWrap" class="map-stick-bottom">
    <div id="map" role="application" aria-label="World map"></div>

    <!-- cooldown bar -->
    <div id="cooldown" class="cooldown hidden" aria-live="polite">
      <div id="cooldownFill" class="cooldown-fill"></div>
      <span id="cooldownText">0s</span>
    </div>
  </main>

  <!-- ================== App JS ================== -->
  <script>
    // ---------- Country list ----------
    const COUNTRY_LIST = [
      {code:'JP',name:'Japan'},{code:'US',name:'United States'},{code:'KR',name:'Korea'},
      {code:'CN',name:'China'},{code:'GB',name:'United Kingdom'},{code:'FR',name:'France'},
      {code:'DE',name:'Germany'},{code:'BR',name:'Brazil'},{code:'IN',name:'India'},
      {code:'RU',name:'Russia'},{code:'CA',name:'Canada'},{code:'AU',name:'Australia'}
    ];
    const countrySel = document.getElementById('countrySelect');
    COUNTRY_LIST.forEach(c => {
      const o = document.createElement('option');
      o.value = c.name; o.textContent = c.name; countrySel.append(o);
    });
    countrySel.value = 'Japan';
    let currentCountry = countrySel.value;
    countrySel.addEventListener('change', ()=> currentCountry = countrySel.value);

    // ---------- Tile size ----------
    const tileStored = localStorage.getItem('tile') || '0.0005';
    let TILE = parseFloat(tileStored);
    document.getElementById('tileCustom').value = TILE;

    document.querySelectorAll('.seg-btn[data-tile]').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.seg-btn[data-tile]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        setTile(parseFloat(b.dataset.tile));
      });
    });
    document.getElementById('tileApply').addEventListener('click', ()=>{
      const v = parseFloat(document.getElementById('tileCustom').value);
      if (!isFinite(v) || v <= 0) { alert('Invalid value.'); return; }
      setTile(v);
    });
    function setTile(v){
      TILE = v; localStorage.setItem('tile', String(v));
      reloadLocalPaints();
      invalidateMapAfter(80);
    }

    // ---------- Color ----------
    const colorPicker = document.getElementById('colorPicker');
    const colorHex = document.getElementById('colorHex');
    colorPicker.addEventListener('input', e => colorHex.value = e.target.value);
    colorHex.addEventListener('input', e=>{
      if(/^#?[0-9a-fA-F]{6}$/.test(e.target.value)){
        const v = e.target.value.startsWith('#') ? e.target.value : '#'+e.target.value;
        colorPicker.value = v;
      }
    });

    // ---------- Cooldown ----------
    const COOLDOWN = 10; // seconds
    let lastPaintAt = 0;
    const cdWrap = document.getElementById('cooldown');
    const cdFill = document.getElementById('cooldownFill');
    const cdText = document.getElementById('cooldownText');
    function inCd(){ return Date.now() - lastPaintAt < COOLDOWN*1000; }
    function showCooldown(sec){
      const end = Date.now() + sec*1000;
      cdWrap.classList.remove('hidden');
      const t = setInterval(()=>{
        const left = end - Date.now();
        if (left <= 0){
          clearInterval(t);
          cdWrap.classList.add('hidden');
          cdFill.style.width = '0%';
          cdText.textContent = '0s';
          return;
        }
        cdText.textContent = Math.ceil(left/1000)+'s';
        cdFill.style.width = ((COOLDOWN*1000-left)/(COOLDOWN*1000)*100)+'%';
      }, 100);
    }

    // ---------- Leaflet map ----------
    const map = L.map('map', {worldCopyJump:true}).setView([35.6762,139.6503], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors', maxZoom: 19, detectRetina: true, subdomains:'abc'
    })
    .on('tileerror', e => console.error('tile error', e))
    .addTo(map);

    // „É¨„Ç§„Ç¢„Ç¶„ÉàÂæå„Çµ„Ç§„Ç∫Ë™øÊï¥
    const invalidateMapAfter = (ms=100)=> setTimeout(()=>map.invalidateSize({animate:false}), ms);
    invalidateMapAfter(120);

    // details ÈñãÈñâ„ÉªÂõûËª¢„Éª„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´„Çµ„Ç§„Ç∫Ë™øÊï¥
    document.querySelectorAll('.info-panels details')
      .forEach(d => d.addEventListener('toggle', ()=> invalidateMapAfter(150)));
    window.addEventListener('resize', ()=> invalidateMapAfter(150));
    window.addEventListener('orientationchange', ()=> invalidateMapAfter(220));
    new IntersectionObserver((es)=>{ if (es[0].isIntersecting) invalidateMapAfter(80); },
      {threshold:.1}).observe(document.getElementById('map'));

    // ---------- Paint (local only) ----------
    const layerTiles = L.layerGroup().addTo(map);
    const snap = v => Math.floor(v / TILE) * TILE;
    const keyFrom = (lat,lng)=>`${snap(lat).toFixed(6)},${snap(lng).toFixed(6)}`;
    const rectFor = (lat,lng,color)=>{
      const lat0 = snap(lat), lng0 = snap(lng);
      return L.rectangle([[lat0,lng0],[lat0+TILE,lng0+TILE]], {color, fillColor:color, fillOpacity:.5, weight:1});
    };

    const LS_KEY = 'teplace-local-tiles-v1';
    function loadLocal(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; }
    }
    function saveLocal(d){
      localStorage.setItem(LS_KEY, JSON.stringify(d));
    }
    function reloadLocalPaints(){
      layerTiles.clearLayers();
      const data = loadLocal();
      Object.values(data).forEach(t => rectFor(t.lat,t.lng,t.color).addTo(layerTiles));
      document.getElementById('statTotal').textContent = Object.keys(data).length;
    }
    reloadLocalPaints();

    // click to paint (1√ó1 only)
    map.on('click', (e)=>{
      if (inCd()){ const left = Math.ceil((COOLDOWN*1000 - (Date.now()-lastPaintAt))/1000); showCooldown(left); return; }

      const lat = snap(e.latlng.lat);
      const lng = snap(e.latlng.lng);
      const color = colorPicker.value;
      const key = keyFrom(lat,lng);

      const data = loadLocal();
      data[key] = { key, lat, lng, color, country: currentCountry, ts: Date.now() };
      saveLocal(data);

      rectFor(lat,lng,color).addTo(layerTiles);
      document.getElementById('statTotal').textContent = Object.keys(data).length;
      // Ëá™ÂàÜ„ÅÆ„Ç´„Ç¶„É≥„Éà„ÅØÁ∞°ÊòìÁöÑ„Å´ +1
      const mine = parseInt(document.getElementById('statMine').textContent || '0', 10) + 1;
      document.getElementById('statMine').textContent = mine;

      lastPaintAt = Date.now();
      showCooldown(COOLDOWN);
    });

    // „É©„É≥„Ç≠„É≥„Ç∞ÔºÜ„Ç™„É≥„É©„Ç§„É≥„ÅØ„ÉÄ„Éü„Éº
    function refreshDummy(){
      document.getElementById('statOnline').textContent = Math.floor(200+Math.random()*600);
      // „É©„É≥„Ç≠„É≥„Ç∞„ÅØÂõΩÂà•„ÅÆ„É≠„Éº„Ç´„É´ÈõÜË®àÔºàÁ∞°ÊòìÔºâ
      const data = loadLocal();
      const counts = {};
      Object.values(data).forEach(t => { counts[t.country] = (counts[t.country]||0) + 1; });
      const arr = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const ul = document.getElementById('rankingList'); ul.innerHTML = '';
      if (arr.length === 0){ ul.innerHTML = '<li>No data yet</li>'; return; }
      arr.forEach(([name, count], i)=>{
        const li = document.createElement('li');
        li.innerHTML = `<span class="rank">${i+1}</span><span class="country">${name}</span><strong class="count">${count}</strong>`;
        ul.append(li);
      });
    }
    refreshDummy();
    setInterval(refreshDummy, 8000);

    document.querySelectorAll('.seg-btn[data-period]').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.seg-btn[data-period]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        refreshDummy();
      });
    });

    // Sign „Éú„Çø„É≥Ôºà„ÉÄ„Éü„ÉºÔºâ
    const signBtn = document.getElementById('signBtn');
    let signed = false;
    signBtn.addEventListener('click', ()=>{
      signed = !signed;
      signBtn.textContent = signed ? 'Sign out' : 'Sign in';
    });
  </script>
</body>
</html>
