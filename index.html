<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TePlace — Real World Map Conquest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
    defer
  ></script>
</head>
<body>

  <!-- 画面最上部に浮かせる極小バー（モバイル優先） -->
  <header class="floating-bar">
    <div class="brand">🌍 TePlace</div>
    <div class="inline-controls">
      <label class="country-pill" title="Your country">
        <span class="label">Country</span>
        <select id="countrySelect" aria-label="Your country">
          <!-- JSで追加（既存のCOUNTRY_LISTでもOK） -->
          <option value="Japan">Japan</option>
          <option value="United States">United States</option>
          <option value="Korea">Korea</option>
          <option value="China">China</option>
          <option value="United Kingdom">United Kingdom</option>
          <option value="France">France</option>
          <option value="Germany">Germany</option>
          <option value="Brazil">Brazil</option>
          <option value="India">India</option>
          <option value="Russia">Russia</option>
          <option value="Canada">Canada</option>
          <option value="Australia">Australia</option>
        </select>
      </label>

      <button id="signBtn" class="pill-btn" type="button">Sign in</button>
    </div>
  </header>

  <!-- 地図（全画面） -->
  <main id="mapWrap">
    <div id="map" role="region" aria-label="Game map"></div>

    <!-- マップ右下の小さな色コントロール（必要最低限だけ重ねる） -->
    <div class="map-overlay bottom-right stack">
      <label class="color-chip">
        <input type="color" id="colorPicker" aria-label="Color" />
      </label>

      <!-- クールダウンバー（必要時のみ表示） -->
      <div id="cooldown" class="cooldown hidden" aria-live="polite">
        <div id="cooldownFill" class="bar"></div>
        <span id="cooldownText" class="t"></span>
      </div>
    </div>
  </main>

  <!-- 情報パネルはデフォルト折りたたみ。開くときだけ縦に展開 -->
  <section class="info-panels">
    <details>
      <summary>🏆 World Ranking</summary>
      <div class="seg">
        <button class="seg-btn active" data-period="today">Today</button>
        <button class="seg-btn" data-period="week">Week</button>
        <button class="seg-btn" data-period="month">Month</button>
      </div>
      <ul id="rankingList" class="ranking"></ul>
    </details>

    <details>
      <summary>📊 Statistics</summary>
      <div class="stats-grid">
        <div><small>Total territories</small><strong id="statTotal">0</strong></div>
        <div><small>My territories</small><strong id="statMine">0</strong></div>
        <div><small>Online (approx)</small><strong id="statOnline">0</strong></div>
      </div>
    </details>

    <details>
      <summary>🎨 Color & Tile size</summary>
      <div class="control-block">
        <div class="row">
          <input id="colorHex" class="mono" type="text" value="#ff4b4b" />
          <label class="color-chip">
            <input type="color" id="colorPicker2" />
          </label>
        </div>
        <div class="seg">
          <button class="seg-btn" data-tile="0.005">0.005°</button>
          <button class="seg-btn" data-tile="0.001">0.001°</button>
          <button class="seg-btn active" data-tile="0.0005">0.0005°</button>
        </div>
        <div class="row">
          <input id="tileCustom" class="mono" type="number" step="0.0001" min="0.00001" value="0.0005" />
          <button id="tileApply" class="btn small" type="button">Apply</button>
        </div>
        <small>1×1 only ・ Cooldown: <b>10s</b></small>
      </div>
    </details>
  </section>

  <script>
    // ====== 100vh 問題を回避：地図を常に端末の見える高さに ======
    function setMapHeight() {
      const h = window.innerHeight;           // アドレスバー込みの実高さ
      document.getElementById('map').style.height = h + 'px';
      // Leaflet が読み込み済みならサイズ更新
      if (window.L && window.map) { setTimeout(()=> map.invalidateSize(), 0); }
    }
    window.addEventListener('resize', setMapHeight);
    window.addEventListener('orientationchange', setMapHeight);
    document.addEventListener('DOMContentLoaded', setMapHeight);

    // ====== 既存の JS と接続（シンプル） ======
    // 1) サインボタン（匿名OKならボタン文言だけ切替）
    const signBtn = document.getElementById('signBtn');
    // あなたの既存の auth ロジックに置き換えてください
    let signed = false;
    function setSignedIn(on) {
      signed = on;
      signBtn.textContent = on ? 'Sign out' : 'Sign in';
    }
    signBtn.addEventListener('click', ()=>{
      // 既存の signInAnonymously / signOut を呼び出す
      // 成功時に setSignedIn(true/false) を呼ぶ
      // 例: setSignedIn(!signed);
    });

    // 2) カラー入力の同期（map右下の picker と折りたたみ内の picker/hex を同期）
    const p1 = document.getElementById('colorPicker');
    const p2 = document.getElementById('colorPicker2');
    const hex = document.getElementById('colorHex');
    function syncFromPicker(v){
      hex.value = v.toLowerCase();
      p1.value = v; p2.value = v;
    }
    [p1,p2].forEach(inp=>{
      inp.addEventListener('input', e=> syncFromPicker(e.target.value));
    });
    hex.addEventListener('input', e=>{
      const v = e.target.value.trim();
      if(/^(#)?[0-9a-fA-F]{6}$/.test(v)){
        syncFromPicker(v.startsWith('#')?v:'#'+v);
      }
    });

    // 3) タイルサイズ切替（あなたの setTile を呼ぶ）
    document.querySelectorAll('.seg-btn[data-tile]').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.seg-btn[data-tile]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const v = parseFloat(b.dataset.tile);
        document.getElementById('tileCustom').value = v;
        // 既存の setTile(v) を呼ぶ
        // setTile(v);
      });
    });
    document.getElementById('tileApply').addEventListener('click', ()=>{
      const v = parseFloat(document.getElementById('tileCustom').value);
      if(!isFinite(v) || v <= 0){ alert('Invalid value'); return; }
      // setTile(v);
    });

    // 4) クールダウン操作は既存の showCooldown/lastPaintAt で
    // ここではスタイル/DOMだけ

    // 5) Leafletの初期化は既存コードをそのまま使えます
    // 例:
    // const map = L.map('map', { worldCopyJump: true }).setView([35.6762,139.6503], 6);
    // L.tileLayer(...).addTo(map);
    // window.map = map; // setMapHeight の invalidateSize 用
  </script>
  <script src="script.js" defer></script>
</body>
</html>
